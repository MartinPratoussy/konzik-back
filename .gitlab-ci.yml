image: docker:latest

stages:
  - build-auth
  - build-chat
#  - build-common
  - build-concert
  - build-eureka
  - build-gateway
  - build-ticketmaster

build-auth:
  stage: build-auth
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --name builder-user --use
    - docker buildx inspect --bootstrap
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
#    - docker buildx build --push --platform linux/amd64,linux/arm64,linux/arm/v7 -f ./Dockerfile/auth/Dockerfile -t thomasoss/back-konzik:auth .
    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/auth/Dockerfile -t thomasoss/back-konzik:auth .
  when: auto

build-chat:
  stage: build-chat
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --name builder-user --use
    - docker buildx inspect --bootstrap
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/chat/Dockerfile -t thomasoss/back-konzik:chat .
  when: auto

#build-common:
#  stage: build-common
#  script:
#    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
#    - docker buildx create --name builder-user --use
#    - docker buildx inspect --bootstrap
#    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
#    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/#common/Dockerfile -t thomasoss/back-konzik:common .
#  when: auto

build-concert:
  stage: build-concert
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --name builder-user --use
    - docker buildx inspect --bootstrap
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/concert/Dockerfile -t thomasoss/back-konzik:concert .
  when: auto

build-eureka:
  stage: build-eureka
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --name builder-user --use
    - docker buildx inspect --bootstrap
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/eureka/Dockerfile -t thomasoss/back-konzik:eureka .
  when: auto

build-gateway:
  stage: build-gateway
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --name builder-user --use
    - docker buildx inspect --bootstrap
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/gateway/Dockerfile -t thomasoss/back-konzik:gateway .
  when: auto

build-ticketmaster:
  stage: build-ticketmaster
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --name builder-user --use
    - docker buildx inspect --bootstrap
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker buildx build --push --platform linux/amd64,linux/arm64 -f ./Dockerfile/ticketmaster/Dockerfile -t thomasoss/back-konzik:ticketmaster .
  when: auto
    
  only:
    - dev

variables:
  DOCKER_USERNAME: $DOCKER_USERNAME
  DOCKER_PASSWORD: $DOCKER_PASSWORD

default:
  tags:
    - runner-l
